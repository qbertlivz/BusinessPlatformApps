SET NOCOUNT ON;

SELECT t.threatid,
       c.itemkey                                          MachineID,
       Dateadd(day, Datediff(day, 0, t.detectiontime), 0) AS [Detection Date],
       N'SystemCenter Endpoint Protection'                [Observer Product Name],
       t.productversion                                   [Observer Product Version],
       CASE
         WHEN t.detectionsource = 0 THEN N'Unknown'
         WHEN t.detectionsource = 1 THEN N'User'
         WHEN t.detectionsource = 2 THEN N'System'
         WHEN t.detectionsource = 3 THEN N'Realtime'
         WHEN t.detectionsource = 4 THEN N'IOAV'
         WHEN t.detectionsource = 5 THEN N'NIS'
         WHEN t.detectionsource = 6 THEN N'BHO'
       END                                                [Observer Detection],
       CASE
         WHEN t.cleaningaction = 0 THEN N'Unknown'
         WHEN t.cleaningaction = 1 THEN N'Clean'
         WHEN t.cleaningaction = 2 THEN N'Quarantine'
         WHEN t.cleaningaction = 3 THEN N'Remove'
         WHEN t.cleaningaction = 6 THEN N'Allow'
         WHEN t.cleaningaction = 8 THEN N'UserDefined'
         WHEN t.cleaningaction = 9 THEN N'NoAction'
         WHEN t.cleaningaction = 10 THEN N'Block'
       END                                                AS [Remediation Type],
       CASE
         WHEN t.actionsuccess = 1 THEN N'True'
         ELSE N'False'
       END                                                [Remediation Result],
       t.errorcode                                        [Remediation Error Code],
       CASE
         WHEN t.pendingactions & 4 <> 0 THEN N'FullScan'
         WHEN t.pendingactions & 8 <> 0 THEN N'Reboot'
         WHEN t.pendingactions & 16 <> 0 THEN N'SettingsModified'
         WHEN t.pendingactions & 32768 <> 0 THEN N'SystemSweeper'
         ELSE N'NoActionRequired'
       END                                                [Remediation Pending Action],
       CASE
         WHEN t.actionsuccess = 0 THEN N'True'
         ELSE N'False'
       END                                                [Is Active Malware]
FROM   v_gs_threats t
       INNER JOIN vsms_r_system c
               ON t.resourceid = c.itemkey
       INNER JOIN v_threatcatalog tc
               ON t.threatid = tc.threatid -- REMOVE. DEMO ONLY. WHY ARE SOME THREATS NOT IN THE CATALOG!?
WHERE  c.obsolete0 = 0
       AND c.decommissioned0 = 0;